[plugin]
id = "sekiro"
name = "Sekiro: Shadows Die Twice"
short_name = "SEK"
version = "1.1.0"
author = "NYA Core"
description = "Sekiro autosplitter with full boss tracking"
update_url = "https://raw.githubusercontent.com/valkyaha/NYA-Core-Assets/main/plugins/sekiro/plugin.toml"

# Save file location for practice mode backup/restore
save_location_windows = "%APPDATA%/Sekiro"
save_location_linux = "~/.local/share/Steam/userdata"
save_type = "folder"

[process]
names = ["sekiro.exe"]

# =============================================================================
# RECOMMENDED TOOLS
# =============================================================================

[[tools]]
name = "Sekiro Save Manager"
description = "Backup and manage save files"
author = "Community"
version = "1.0.0"
download_url = "https://github.com/Atvaark/Sekiro.SaveManager/releases"
category = "utility"
required = false

[[tools]]
name = "Sekiro FPS Unlocker"
description = "Unlock framerate beyond 60 FPS"
author = "uberhalit"
version = "Latest"
download_url = "https://github.com/uberhalit/Sekiro FpsUnlockAndMore/releases"
category = "mod"
required = false

[[tools]]
name = "Sekiro Practice Tool"
description = "Practice specific bosses and sections"
author = "Zullie"
version = "Latest"
download_url = "https://github.com/veeenu/sekiro-practice-tool/releases"
category = "practice"
required = false

[autosplitter]
enabled = true
algorithm = "category_decomposition"

# Category decomposition algorithm configuration (Sekiro style)
# Based on SoulSplitter by FrankvdStam
# Sekiro uses different offsets than DS3
[autosplitter.category_config]
primary_pattern = "event_flag_man"
secondary_pattern = "field_area"
base_offset = 536           # 0x218
entry_size = 24             # 0x18
category_count = 6
category_multiplier = 168   # 0xa8
# Sekiro: FieldArea -> 0x48 -> 0x18
field_area_base_offset = 72 # 0x48
world_info_offset = 24      # 0x18
world_info_struct_size = 56 # 0x38
world_block_struct_size = 176  # 0xb0

# Memory patterns for finding game data structures
[[autosplitter.patterns]]
name = "event_flag_man"
pattern = "48 8b 0d ? ? ? ? 48 89 5c 24 50 48 89 6c 24 58 48 89 74 24 60"
rip_offset = 3
instruction_len = 7

[[autosplitter.patterns]]
name = "field_area"
pattern = "48 8B 0D ? ? ? ? 48 85 C9 74 26 44 8B 41 28 48 8D 54 24 40"
rip_offset = 3
instruction_len = 7
pointer_offsets = []  # No dereference - raw address

[[autosplitter.patterns]]
name = "world_chr_man"
pattern = "48 8B 35 ? ? ? ? 44 0F 28 18"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0]

[[autosplitter.patterns]]
name = "igt"
pattern = "48 8B 05 ? ? ? ? 32 D2 48 8B 48"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0, 0x9C]

[[autosplitter.patterns]]
name = "fade_man_imp"
pattern = "48 89 35 ? ? ? ? 48 8B C7 48 8B"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0]

[[autosplitter.patterns]]
name = "player_game_data"
pattern = "48 8B 0D ? ? ? ? 48 8B 41 20 C6"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0, 0x8]

# =============================================================================
# POINTER CHAINS - Derived pointers from base patterns
# =============================================================================

[autosplitter.pointers]
# Player position from WorldChrMan
player_pos = { base = "world_chr_man", offsets = [0, 0x48, 0x28] }

# Fade system from FadeManImp
fade_system = { base = "fade_man_imp", offsets = [0, 0x8] }

# =============================================================================
# MEMORY LAYOUT - Offsets for reading values
# =============================================================================

[autosplitter.memory_layout]
# Event flag calculation offsets (similar to DS3 but different strides)
event_flag_base_offset = 0x218
event_flag_stride = 0x18
block_stride = 0xB0  # Sekiro-specific
block_category_stride = 0xA8
field_area_offset = 0x18  # Sekiro-specific

# Position offsets from PlayerPos
position_x = 0x80
position_y = 0x84
position_z = 0x88

# Player loaded check at WorldChrMan + 0x88
player_loaded_offset = 0x88

# Blackscreen check at FadeSystem + 0x2DC
blackscreen_offset = 0x2DC

# Attribute offsets from PlayerGameData
[autosplitter.memory_layout.attributes]
vitality = 0x44
attack_power = 0x48

# =============================================================================
# LIVESPLIT-STYLE SCRIPT CONFIGURATION
# =============================================================================

[script]
version = "1.0"
name = "Sekiro Script"
description = "LiveSplit-style autosplitter script for Sekiro: Shadows Die Twice"

[script.state.eventFlagMan]
type = "ptr"
pattern = "48 8b 0d ?? ?? ?? ?? 48 89 5c 24 50 48 89 6c 24 58 48 89 74 24 60"
pattern_offset = 3
pattern_length = 7

[script.state.inGame]
type = "bool"
base_watcher = "eventFlagMan"
offsets = [0x0]

[script.hooks]
start = "settings.autostart && current.inGame && !old.inGame"
reset = "settings.autoreset && !current.inGame && old.inGame"
split = "settings.splitOnDeath && current.playerHP == 0 && old.playerHP > 0"

[script.settings]
autostart = { default = true, label = "Auto-start timer", description = "Start timer when entering a new game" }
autoreset = { default = false, label = "Auto-reset on menu", description = "Reset timer when returning to main menu" }
splitOnDeath = { default = false, label = "Split on death", description = "Trigger split when player dies" }

# =============================================================================
# BOSSES
# =============================================================================

# Main Game Bosses
[[bosses]]
id = "gyoubu"
name = "Gyoubu Masataka Oniwa"
location = "Ashina Outskirts"
required = true
is_dlc = false
flag_id = 9301
order = 1
aliases = ["Gyoubu Oniwa"]

[[bosses]]
id = "lady_butterfly"
name = "Lady Butterfly"
location = "Hirata Estate"
required = false
is_dlc = false
flag_id = 9302
order = 2

[[bosses]]
id = "genichiro"
name = "Genichiro Ashina"
location = "Ashina Castle"
required = true
is_dlc = false
flag_id = 9303
order = 3

[[bosses]]
id = "guardian_ape"
name = "Guardian Ape"
location = "Sunken Valley"
required = true
is_dlc = false
flag_id = 9304
order = 4

[[bosses]]
id = "folding_monkeys"
name = "Folding Screen Monkeys"
location = "Senpou Temple"
required = true
is_dlc = false
flag_id = 9305
order = 5

[[bosses]]
id = "corrupted_monk_illusion"
name = "Corrupted Monk (Illusion)"
location = "Mibu Village"
required = true
is_dlc = false
flag_id = 9306
order = 6
aliases = ["Ghost Monk"]

[[bosses]]
id = "headless_ape"
name = "Headless Ape"
location = "Ashina Depths"
required = false
is_dlc = false
flag_id = 9307
order = 7

[[bosses]]
id = "great_shinobi_owl"
name = "Great Shinobi Owl"
location = "Ashina Castle"
required = true
is_dlc = false
flag_id = 9308
order = 8
aliases = ["Owl"]

[[bosses]]
id = "corrupted_monk"
name = "True Corrupted Monk"
location = "Fountainhead Palace"
required = true
is_dlc = false
flag_id = 9309
order = 9

[[bosses]]
id = "divine_dragon"
name = "Divine Dragon"
location = "Fountainhead Palace"
required = true
is_dlc = false
flag_id = 9310
order = 10

[[bosses]]
id = "isshin_glock"
name = "Isshin, the Sword Saint"
location = "Ashina Reservoir"
required = true
is_dlc = false
flag_id = 9312
order = 11

[[bosses]]
id = "demon_of_hatred"
name = "Demon of Hatred"
location = "Ashina Outskirts"
required = false
is_dlc = false
flag_id = 9313
order = 12

[[bosses]]
id = "emma"
name = "Emma, the Gentle Blade"
location = "Ashina Castle"
required = false
is_dlc = false
flag_id = 9315
order = 13

[[bosses]]
id = "isshin_sword"
name = "Isshin Ashina"
location = "Ashina Castle"
required = false
is_dlc = false
flag_id = 9316
order = 14

[[bosses]]
id = "owl_father"
name = "Owl (Father)"
location = "Hirata Estate"
required = false
is_dlc = false
flag_id = 9317
order = 15
aliases = ["Father Owl"]

# =============================================================================
# IDOLS - All 47 Sculptor's Idols from SoulSplitter
# =============================================================================

# Ashina Outskirts
[[idols]]
id = "dilapidated_temple"
name = "Dilapidated Temple"
location = "Ashina Outskirts"
flag_id = 11100000

[[idols]]
id = "ashina_outskirts"
name = "Ashina Outskirts"
location = "Ashina Outskirts"
flag_id = 11100006

[[idols]]
id = "outskirts_wall_gate"
name = "Outskirts Wall - Gate Path"
location = "Ashina Outskirts"
flag_id = 11100001

[[idols]]
id = "outskirts_wall_stairway"
name = "Outskirts Wall - Stairway"
location = "Ashina Outskirts"
flag_id = 11100002

[[idols]]
id = "underbridge_valley"
name = "Underbridge Valley"
location = "Ashina Outskirts"
flag_id = 11100003

[[idols]]
id = "ashina_castle_fortress"
name = "Ashina Castle Fortress"
location = "Ashina Outskirts"
flag_id = 11100004

[[idols]]
id = "ashina_castle_gate"
name = "Ashina Castle Gate"
location = "Ashina Outskirts"
flag_id = 11100005

[[idols]]
id = "flames_of_hatred"
name = "Flames of Hatred"
location = "Ashina Outskirts"
flag_id = 11100007

# Hirata Estate
[[idols]]
id = "dragonspring"
name = "Dragonspring - Hirata Estate"
location = "Hirata Estate"
flag_id = 11000000

[[idols]]
id = "estate_path"
name = "Estate Path"
location = "Hirata Estate"
flag_id = 11000001

[[idols]]
id = "bamboo_thicket"
name = "Bamboo Thicket Slope"
location = "Hirata Estate"
flag_id = 11000002

[[idols]]
id = "hirata_main_hall"
name = "Hirata Estate - Main Hall"
location = "Hirata Estate"
flag_id = 11000003

[[idols]]
id = "hirata_audience"
name = "Hirata Audience Chamber"
location = "Hirata Estate"
flag_id = 11000005

[[idols]]
id = "hirata_hidden_temple"
name = "Hirata Estate - Hidden Temple"
location = "Hirata Estate"
flag_id = 11000004

# Ashina Castle
[[idols]]
id = "ashina_castle"
name = "Ashina Castle"
location = "Ashina Castle"
flag_id = 11110000

[[idols]]
id = "upper_tower_antechamber"
name = "Upper Tower - Antechamber"
location = "Ashina Castle"
flag_id = 11110001

[[idols]]
id = "upper_tower_dojo"
name = "Upper Tower - Ashina Dojo"
location = "Ashina Castle"
flag_id = 11110007

[[idols]]
id = "castle_tower_lookout"
name = "Castle Tower Lookout"
location = "Ashina Castle"
flag_id = 11110002

[[idols]]
id = "upper_tower_kuros_room"
name = "Upper Tower - Kuro's Room"
location = "Ashina Castle"
flag_id = 11110003

[[idols]]
id = "old_grave"
name = "Old Grave"
location = "Ashina Castle"
flag_id = 11110006

[[idols]]
id = "great_serpent_shrine"
name = "Great Serpent Shrine"
location = "Ashina Castle"
flag_id = 11110004

[[idols]]
id = "abandoned_dungeon_entrance"
name = "Abandoned Dungeon Entrance"
location = "Ashina Castle"
flag_id = 11110005

[[idols]]
id = "ashina_reservoir"
name = "Ashina Reservoir"
location = "Ashina Castle"
flag_id = 11120001

[[idols]]
id = "near_secret_passage"
name = "Near Secret Passage"
location = "Ashina Castle"
flag_id = 11120000

# Abandoned Dungeon
[[idols]]
id = "underground_waterway"
name = "Underground Waterway"
location = "Abandoned Dungeon"
flag_id = 11300000

[[idols]]
id = "bottomless_hole"
name = "Bottomless Hole"
location = "Abandoned Dungeon"
flag_id = 11300001

# Senpou Temple
[[idols]]
id = "senpou_temple"
name = "Senpou Temple, Mt. Kongo"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000000

[[idols]]
id = "shugendo"
name = "Shugendo"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000001

[[idols]]
id = "temple_grounds"
name = "Temple Grounds"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000002

[[idols]]
id = "main_hall"
name = "Main Hall"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000003

[[idols]]
id = "inner_sanctum"
name = "Inner Sanctum"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000004

[[idols]]
id = "sunken_valley_cavern"
name = "Sunken Valley Cavern"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000005

[[idols]]
id = "bell_demons_temple"
name = "Bell Demon's Temple"
location = "Senpou Temple, Mt. Kongo"
flag_id = 12000006

# Sunken Valley
[[idols]]
id = "under_shrine_valley"
name = "Under-Shrine Valley"
location = "Sunken Valley"
flag_id = 11700007

[[idols]]
id = "sunken_valley"
name = "Sunken Valley"
location = "Sunken Valley"
flag_id = 11700000

[[idols]]
id = "gun_fort"
name = "Gun Fort"
location = "Sunken Valley"
flag_id = 11700001

[[idols]]
id = "riven_cave"
name = "Riven Cave"
location = "Sunken Valley"
flag_id = 11700002

[[idols]]
id = "bodhisattva_valley"
name = "Bodhisattva Valley"
location = "Sunken Valley"
flag_id = 11700008

[[idols]]
id = "guardian_ape_watering_hole"
name = "Guardian Ape's Watering Hole"
location = "Sunken Valley"
flag_id = 11700003

# Ashina Depths
[[idols]]
id = "ashina_depths"
name = "Ashina Depths"
location = "Ashina Depths"
flag_id = 11700005

[[idols]]
id = "poison_pool"
name = "Poison Pool"
location = "Ashina Depths"
flag_id = 11700004

[[idols]]
id = "guardian_ape_burrow"
name = "Guardian Ape's Burrow"
location = "Ashina Depths"
flag_id = 11700006

[[idols]]
id = "hidden_forest"
name = "Hidden Forest"
location = "Ashina Depths"
flag_id = 11500000

[[idols]]
id = "mibu_village"
name = "Mibu Village"
location = "Ashina Depths"
flag_id = 11500001

[[idols]]
id = "water_mill"
name = "Water Mill"
location = "Ashina Depths"
flag_id = 11500002

[[idols]]
id = "wedding_cave_door"
name = "Wedding Cave Door"
location = "Ashina Depths"
flag_id = 11500003

# Fountainhead Palace
[[idols]]
id = "fountainhead_palace"
name = "Fountainhead Palace"
location = "Fountainhead Palace"
flag_id = 12500000

[[idols]]
id = "vermilion_bridge"
name = "Vermilion Bridge"
location = "Fountainhead Palace"
flag_id = 12500001

[[idols]]
id = "mibu_manor"
name = "Mibu Manor"
location = "Fountainhead Palace"
flag_id = 12500006

[[idols]]
id = "flower_viewing_stage"
name = "Flower Viewing Stage"
location = "Fountainhead Palace"
flag_id = 12500002

[[idols]]
id = "great_sakura"
name = "Great Sakura"
location = "Fountainhead Palace"
flag_id = 12500003

[[idols]]
id = "palace_grounds"
name = "Palace Grounds"
location = "Fountainhead Palace"
flag_id = 12500004

[[idols]]
id = "feeding_grounds"
name = "Feeding Grounds"
location = "Fountainhead Palace"
flag_id = 12500007

[[idols]]
id = "near_pot_noble"
name = "Near Pot Noble"
location = "Fountainhead Palace"
flag_id = 12500008

[[idols]]
id = "sanctuary"
name = "Sanctuary"
location = "Fountainhead Palace"
flag_id = 12500005

# =============================================================================
# PRESETS
# =============================================================================

[[presets]]
id = "all-bosses"
name = "All Bosses"
description = "All main game bosses (15 bosses)"
boss_ids = [
    "gyoubu", "lady_butterfly", "genichiro", "guardian_ape", "folding_monkeys",
    "corrupted_monk_illusion", "headless_ape", "great_shinobi_owl", "corrupted_monk",
    "divine_dragon", "isshin_glock", "demon_of_hatred", "emma", "isshin_sword", "owl_father"
]

[[presets]]
id = "any-percent"
name = "Immortal Severance Ending"
description = "Required bosses only (10 bosses)"
boss_ids = [
    "gyoubu", "genichiro", "guardian_ape", "folding_monkeys",
    "corrupted_monk_illusion", "great_shinobi_owl", "corrupted_monk",
    "divine_dragon", "isshin_glock"
]

[[presets]]
id = "shura"
name = "Shura Ending"
description = "Shura route bosses"
boss_ids = [
    "gyoubu", "genichiro", "guardian_ape", "folding_monkeys",
    "corrupted_monk_illusion", "great_shinobi_owl", "emma", "isshin_sword"
]
